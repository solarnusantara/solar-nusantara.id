---
import { navLinks, type NavLink } from '../data/navLinks';

---

<nav id="main-navbar" class="hidden lg:flex w-full items-center justify-center bg-white h-16 sticky top-0 z-40 shadow-sm">
  <div class="container mx-auto px-4 flex items-center justify-center">
    <ul class="flex items-center gap-6">
      {navLinks.map(link => (
        <li class="relative group">
          <a 
            href={link.href || '#'} 
            class="flex items-center gap-2 text-center text-gray-700 font-medium transition-colors duration-300 py-2 px-4"
            class:list={{'text-blue-600':(link.href && Astro.url.pathname.startsWith(link.href) && link.href !== '/') || (Astro.url.pathname === '/' && link.href === '/')}}
          >
            <span>{link.text}</span>
            {link.children && (
              <svg class="w-3 h-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
            )}
          </a>
          <span 
            class="absolute -top-3 left-1/2 -translate-x-1/2 h-1 bg-blue-600 transition-all duration-300"
            class:list={{'w-full':(link.href && Astro.url.pathname.startsWith(link.href) && link.href !== '/') || (Astro.url.pathname === '/' && link.href === '/'), 'w-0 group-hover:w-full': !((link.href && Astro.url.pathname.startsWith(link.href) && link.href !== '/') || (Astro.url.pathname === '/' && link.href === '/'))}}
          ></span>
          
          {/* First level submenu */}
          {link.children && (
            <ul class="absolute top-full left-0 w-56 bg-white shadow-lg rounded-md hidden group-hover:block z-50">
              {link.children.map(child => (
                <li class="relative group/sub">
                  <a 
                    href={child.href || '#'} 
                    class="flex items-center justify-between w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"
                    class:list={{'text-blue-600 bg-gray-100': child.href && Astro.url.pathname.startsWith(child.href)}}
                  >
                    <span>{child.text}</span>
                    {child.children && (
                      <svg class="w-3 h-3 fill-current transform -rotate-90" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    )}
                  </a>

                  {/* Second level sub-submenu */}
                  {child.children && (
                    <ul class="absolute top-0 left-full w-56 bg-white shadow-lg rounded-md hidden group-hover/sub:block">
                      {child.children.map(subChild => (
                        <li class="relative group/sub">
                          <a 
                            href={subChild.href || '#'} 
                            class="flex items-center justify-between w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"
                            class:list={{'text-blue-600 bg-gray-100': subChild.href && Astro.url.pathname.startsWith(subChild.href)}}
                          >
                            <span>{subChild.text}</span>
                            {subChild.children && (
                              <svg class="w-3 h-3 fill-current transform -rotate-90" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            )}
                          </a>

                          {/* Third level sub-submenu */}
                          {subChild.children && (
                            <ul class="absolute top-0 left-full w-56 bg-white shadow-lg rounded-md hidden group-hover/sub:block">
                              {subChild.children.map(superSubChild => (
                                <li>
                                  <a 
                                    href={superSubChild.href || '#'} 
                                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                    class:list={{'text-blue-600 bg-gray-100': superSubChild.href && Astro.url.pathname.startsWith(superSubChild.href)}}
                                  >
                                    {superSubChild.text}
                                  </a>
                                </li>
                              ))}
                            </ul>
                          )}
                        </li>
                      ))}
                    </ul>
                  )}
                </li>
              ))}
            </ul>
          )}
        </li>
      ))}
    </ul>
  </div>
</nav>

<script>
  // Ensure the DOM is fully loaded before trying to access elements
  document.addEventListener('DOMContentLoaded', () => { // Changed event
    const nav = document.querySelector('#main-navbar');
    if (!nav) {
        console.warn('Navbar element with ID #main-navbar not found.');
        return;
    }

    let isScrolled = nav.classList.contains('navbar-scrolled');

    const handleScroll = () => {
      const shouldBeScrolled = window.scrollY > 20;
      if (shouldBeScrolled !== isScrolled) {
        isScrolled = shouldBeScrolled;
        nav.classList.toggle('navbar-scrolled', isScrolled);
      }
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    
    // Initial check in case of reload or page is already scrolled
    handleScroll();
  });
</script>

<style>
  #main-navbar.navbar-scrolled {
    @apply rounded-full shadow-lg bg-white mx-auto; /* Removed mt-4 */
    width: 95%;
    max-width: 1024px;
    top: 0.5rem; /* Added this to set explicit top margin */
  }
</style>
