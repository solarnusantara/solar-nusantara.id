---
import Header from '../components/Header.astro';
import Navbar from '../components/Navbar.astro';
import MobileHeader from '../components/MobileHeader.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';

interface Heading {
  depth: number;
  text: string;
  slug: string;
}

interface Props {
  headings?: Heading[];
  frontmatter?: {
    title: string;
  };
  title?: string;
}

const { headings, frontmatter, title: directTitle } = Astro.props;

// This is the key change: Detect if the page is from Markdown based on `frontmatter`
const isMarkdownPage = !!frontmatter;

// Determine title based on page type
const title = isMarkdownPage ? frontmatter.title : directTitle || 'Solar Nusantara';
const hasHeadings = headings && headings.length > 0;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Astro description" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>

		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" media="print" onload="this.media='all'">
		<noscript>
		  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
		</noscript>
	</head>
	<body class="bg-white min-h-screen flex flex-col">
		<Header />
		<Navbar />
		<MobileHeader />
		
    {isMarkdownPage ? (
      // Smart Layout for .md pages
      <main class="flex-grow">
        <div class="container mx-auto px-4 py-16">
          {hasHeadings ? (
            // With Table of Contents
            <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">
              <aside class="hidden lg:w-1/4 lg:sticky lg:top-24 self-start">
                <nav id="toc-nav" class="border-l-2 border-gray-200 pl-4">
                  <h2 class="font-bold text-lg mb-4 text-gray-800">Di Halaman ini</h2>
                  <ul class="space-y-2">
                    {headings.filter(h => h.depth === 2 || h.depth === 3).map(heading => (
                      <li>
                        <a href={`#${heading.slug}`} data-slug={heading.slug} class:list={["toc-link text-gray-500 hover:text-blue-600 transition-colors duration-200", { 'pl-4': heading.depth === 3 }]}>
                          {heading.text}
                        </a>
                      </li>
                    ))}
                  </ul>
                </nav>
              </aside>
              <div class="flex-1 w-full lg:w-3/4">
                <article class="prose lg:prose-xl mx-auto">
                  <h1>{title}</h1>
                  <slot />
                </article>
              </div>
            </div>
          ) : (
            // Without Table of Contents
            <article class="prose lg:prose-xl mx-auto">
              <h1>{title}</h1>
              <slot />
            </article>
          )}
        </div>
      </main>
    ) : (
      // Simple Layout for .astro pages
      <main class="flex-grow">
        <slot />
      </main>
    )}

		<Footer />

    {hasHeadings && (
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const tocLinks = document.querySelectorAll('.toc-link');
          const headings = Array.from(document.querySelectorAll('h2, h3'));
          if (!tocLinks.length || !headings.length) return;
          const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
              const slug = entry.target.id;
              const tocLink = document.querySelector(`.toc-link[data-slug="${slug}"]`);
              if (entry.isIntersecting) {
                tocLinks.forEach(link => link.classList.remove('is-active'));
                tocLink?.classList.add('is-active');
              }
            });
          }, { rootMargin: '-50% 0px -50% 0px', threshold: 0 });
          headings.forEach(heading => observer.observe(heading));
        });
      </script>
    )}

    <style is:global>
      .toc-link.is-active {
        @apply text-blue-600 font-semibold;
        transform: scale(1.05);
      }
    </style>
	</body>
</html>